<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrendVision Admin Panel</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <h1>🔧 TrendVision Admin Panel</h1>
            <div class="admin-info">
                <span>Welcome, {{ session.username }}</span>
                <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>
            </div>
        </div>

        <!-- Daily Configuration Section -->
        <div class="admin-section">
            <h2>📅 Daily Configuration</h2>

            <!-- Access Token Update -->
            <div class="config-card">
                <h3>🔑 Upstox Access Token</h3>
                <form id="token-form">
                    <div class="form-group">
                        <label>Access Token (Daily Update Required):</label>
                        <textarea id="access-token" placeholder="Paste your daily Upstox access token here..." rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn-primary">Update Token</button>
                </form>
            </div>

            <!-- Future Instrument Key -->
            <div class="config-card">
                <h3>📈 NIFTY Future Key</h3>
                <form id="future-form">
                    <div class="form-group">
                        <label>Future Instrument Key:</label>
                        <input type="text" id="future-key" placeholder="NSE_FO|53001" value="NSE_FO|53001">
                    </div>
                    <button type="submit" class="btn-primary">Update Future Key</button>
                </form>
            </div>
        </div>

        <!-- Weekly Configuration Section -->
        <div class="admin-section">
            <h2>📊 Weekly Configuration</h2>

            <!-- CSV Upload -->
            <div class="config-card">
                <h3>📋 Options CSV Upload</h3>
                <form id="csv-form" enctype="multipart/form-data">
                    <div class="form-group">
                        <label>Upload extracted_data.csv (Weekly Update):</label>
                        <input type="file" id="csv-file" accept=".csv" required>
                    </div>
                    <div class="csv-info">
                        <p>Current CSV: <span id="current-csv-info">Not uploaded</span></p>
                        <p>Last Updated: <span id="csv-last-updated">Never</span></p>
                    </div>
                    <button type="submit" class="btn-primary">Upload CSV</button>
                </form>
            </div>
        </div>

        <!-- System Status Section -->
        <div class="admin-section">
            <h2>⚡ System Status</h2>

            <div class="status-grid">
                <div class="status-card">
                    <h4>Pipeline Status</h4>
                    <div class="status-indicator" id="pipeline-status">
                        <span class="status-dot"></span>
                        <span class="status-text">Checking...</span>
                    </div>
                </div>

                <div class="status-card">
                    <h4>Market Hours</h4>
                    <div class="status-indicator" id="market-status">
                        <span class="status-dot"></span>
                        <span class="status-text">Checking...</span>
                    </div>
                </div>

                <div class="status-card">
                    <h4>Memory Usage</h4>
                    <div class="memory-info" id="memory-info">
                        <div class="memory-bar">
                            <div class="memory-used" id="memory-used"></div>
                        </div>
                        <span class="memory-text" id="memory-text">Loading...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Service Control Section -->
        <div class="admin-section">
            <h2>🔧 Service Control</h2>

            <div class="service-controls">
                <button class="btn-success" onclick="restartPipeline()">🔄 Restart Pipeline</button>
                <button class="btn-warning" onclick="restartWebApp()">🔄 Restart Web App</button>
                <button class="btn-danger" onclick="cleanupDatabase()">🗑️ Cleanup Old Data</button>
            </div>
        </div>
    </div>

    <script>
        // Admin panel JavaScript
        document.getElementById('token-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const token = document.getElementById('access-token').value;

            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ACCESS_TOKEN: token})
                });

                if (response.ok) {
                    alert('✅ Access token updated successfully!');
                    document.getElementById('access-token').value = '';
                } else {
                    alert('❌ Failed to update token');
                }
            } catch (error) {
                alert('❌ Error updating token: ' + error.message);
            }
        });

        document.getElementById('future-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const futureKey = document.getElementById('future-key').value;

            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({NIFTY_FUTURE_key: futureKey})
                });

                if (response.ok) {
                    alert('✅ Future key updated successfully!');
                } else {
                    alert('❌ Failed to update future key');
                }
            } catch (error) {
                alert('❌ Error updating future key: ' + error.message);
            }
        });

        document.getElementById('csv-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fileInput = document.getElementById('csv-file');
            const file = fileInput.files[0];

            if (!file) {
                alert('Please select a CSV file');
                return;
            }

            const formData = new FormData();
            formData.append('csv_file', file);

            try {
                const response = await fetch('/api/upload-csv', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    alert('✅ CSV uploaded successfully!');
                    fileInput.value = '';
                    updateCSVInfo();
                } else {
                    alert('❌ Failed to upload CSV');
                }
            } catch (error) {
                alert('❌ Error uploading CSV: ' + error.message);
            }
        });

        // Load system status
        async function loadSystemStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();

                if (data.ok) {
                    // Update pipeline status
                    const pipelineStatus = document.getElementById('pipeline-status');
                    const pipelineDot = pipelineStatus.querySelector('.status-dot');
                    const pipelineText = pipelineStatus.querySelector('.status-text');

                    if (data.pipeline_running) {
                        pipelineDot.style.background = '#4caf50';
                        pipelineText.textContent = 'RUNNING';
                    } else {
                        pipelineDot.style.background = '#f44336';
                        pipelineText.textContent = 'STOPPED';
                    }

                    // Update market status
                    const marketStatus = document.getElementById('market-status');
                    const marketDot = marketStatus.querySelector('.status-dot');
                    const marketText = marketStatus.querySelector('.status-text');

                    if (data.market_hours) {
                        marketDot.style.background = '#4caf50';
                        marketText.textContent = 'OPEN';
                    } else {
                        marketDot.style.background = '#ff9800';
                        marketText.textContent = 'CLOSED';
                    }

                    // Update memory info
                    const memoryUsed = document.getElementById('memory-used');
                    const memoryText = document.getElementById('memory-text');

                    const memoryPercent = data.memory.percentage;
                    memoryUsed.style.width = memoryPercent + '%';
                    memoryText.textContent = `${data.memory.used}GB / ${data.memory.total}GB (${memoryPercent.toFixed(1)}%)`;

                    if (memoryPercent > 80) {
                        memoryUsed.style.background = '#f44336';
                    } else if (memoryPercent > 60) {
                        memoryUsed.style.background = '#ff9800';
                    } else {
                        memoryUsed.style.background = '#4caf50';
                    }
                }
            } catch (error) {
                console.error('Error loading system status:', error);
            }
        }

        // Service control functions
        async function restartPipeline() {
            if (confirm('Restart trading pipeline? This will briefly interrupt data collection.')) {
                try {
                    const response = await fetch('/api/restart-pipeline', {method: 'POST'});
                    if (response.ok) {
                        alert('✅ Pipeline restart initiated');
                    } else {
                        alert('❌ Failed to restart pipeline');
                    }
                } catch (error) {
                    alert('❌ Error: ' + error.message);
                }
            }
        }

        async function restartWebApp() {
            if (confirm('Restart web application? You will be logged out.')) {
                try {
                    const response = await fetch('/api/restart-webapp', {method: 'POST'});
                    if (response.ok) {
                        alert('✅ Web app restart initiated');
                        window.location.href = '/login';
                    } else {
                        alert('❌ Failed to restart web app');
                    }
                } catch (error) {
                    alert('❌ Error: ' + error.message);
                }
            }
        }

        async function cleanupDatabase() {
            if (confirm('Clean up old database records? This will remove data older than 30 days.')) {
                try {
                    const response = await fetch('/admin/cleanup', {method: 'POST'});
                    if (response.ok) {
                        alert('✅ Database cleanup completed');
                    } else {
                        alert('❌ Failed to cleanup database');
                    }
                } catch (error) {
                    alert('❌ Error: ' + error.message);
                }
            }
        }

        // Load status on page load
        loadSystemStatus();
        setInterval(loadSystemStatus, 10000); // Update every 10 seconds
    </script>
</body>
</html>
