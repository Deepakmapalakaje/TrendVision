<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrendVision Admin Panel - Enhanced</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <h1>ğŸ”§ TrendVision Admin Panel - Enhanced</h1>
            <div class="admin-info">
                <span>Welcome, {{ session.username }}</span>
                <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>
            </div>
        </div>

        <!-- Daily Configuration Section -->
        <div class="admin-section">
            <h2>ğŸ“… Daily Configuration</h2>

            <!-- Access Token Update -->
            <div class="config-card">
                <h3>ğŸ”‘ Daily Access Token</h3>
                <form id="token-form">
                    <div class="form-group">
                        <label>Upstox Access Token (Required Daily):</label>
                        <textarea id="access-token" placeholder="Paste your daily Upstox access token here..." rows="3" required></textarea>
                    </div>
                    <button type="submit" class="btn-primary">ğŸ”„ Update Token</button>
                </form>
                <div class="token-status" id="token-status">
                    <p>Last Updated: <span id="token-last-updated">Never</span></p>
                    <p>Status: <span id="token-validation-status">âŒ Not Updated Today</span></p>
                </div>
            </div>

            <!-- Future Instrument Key -->
            <div class="config-card">
                <h3>ğŸ“ˆ NIFTY Future Key</h3>
                <form id="future-form">
                    <div class="form-group">
                        <label>Future Instrument Key (Monthly Update):</label>
                        <input type="text" id="future-key" placeholder="NSE_FO|53001" value="NSE_FO|53001" required>
                    </div>
                    <button type="submit" class="btn-primary">ğŸ“ˆ Update Future Key</button>
                </form>
            </div>
        </div>

        <!-- Automated Options Generation -->
        <div class="admin-section">
            <h2>ğŸ¤– Automated Options Management</h2>

            <!-- Step 1: Fetch Instruments -->
            <div class="config-card">
                <h3>ğŸ“Š Step 1: Fetch Latest Instruments</h3>
                <p>Fetch latest NIFTY instrument keys from Upstox API</p>
                <button id="fetch-instruments-btn" class="btn-primary">ğŸ”„ Fetch Instruments</button>
                <div id="fetch-status" class="status-message"></div>
                <div class="nse-info">
                    <p>NSE.csv Status: <span id="nse-csv-status">Not generated</span></p>
                    <p>Instruments Count: <span id="nse-instruments-count">0</span></p>
                </div>
            </div>

            <!-- Step 2: Select Expiry -->
            <div class="config-card">
                <h3>ğŸ“… Step 2: Select Expiry & Extract Options</h3>
                <div class="form-group">
                    <label>Available Expiry Dates:</label>
                    <select id="expiry-select" required>
                        <option value="">Click 'Fetch Instruments' first</option>
                    </select>
                </div>
                <button id="extract-options-btn" class="btn-primary" disabled>ğŸ“Š Extract 60 Options</button>
                <div id="extract-status" class="status-message"></div>
            </div>

            <!-- Current Options Info -->
            <div class="config-card">
                <h3>ğŸ“‹ Current Options Status</h3>
                <div class="options-info">
                    <p>Total Options: <span id="current-options-count">0</span></p>
                    <p>CE Options: <span id="current-ce-count">0</span></p>
                    <p>PE Options: <span id="current-pe-count">0</span></p>
                    <p>Last Updated: <span id="options-last-updated">Never</span></p>
                </div>
            </div>
        </div>

        <!-- Manual CSV Upload (Backup Option) -->
        <div class="admin-section">
            <h2>ğŸ“‹ Manual CSV Upload (Backup)</h2>

            <div class="config-card">
                <h3>ğŸ“ Manual CSV Upload</h3>
                <form id="csv-form" enctype="multipart/form-data">
                    <div class="form-group">
                        <label>Upload extracted_data.csv (Manual Backup):</label>
                        <input type="file" id="csv-file" accept=".csv" required>
                    </div>
                    <button type="submit" class="btn-secondary">ğŸ“¤ Upload CSV</button>
                </form>
            </div>
        </div>

        <!-- System Status Section -->
        <div class="admin-section">
            <h2>âš¡ System Status</h2>

            <div class="status-grid">
                <div class="status-card">
                    <h4>Trading Pipeline</h4>
                    <div class="status-indicator" id="pipeline-status">
                        <span class="status-dot"></span>
                        <span class="status-text">Checking...</span>
                    </div>
                </div>

                <div class="status-card">
                    <h4>Market Hours</h4>
                    <div class="status-indicator" id="market-status">
                        <span class="status-dot"></span>
                        <span class="status-text">Checking...</span>
                    </div>
                </div>

                <div class="status-card">
                    <h4>Memory Usage</h4>
                    <div class="memory-info" id="memory-info">
                        <div class="memory-bar">
                            <div class="memory-used" id="memory-used"></div>
                        </div>
                        <span class="memory-text" id="memory-text">Loading...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Service Control Section -->
        <div class="admin-section">
            <h2>ğŸ”§ Service Control</h2>

            <div class="service-controls">
                <button class="btn-success" onclick="restartPipeline()">ğŸ”„ Restart Pipeline</button>
                <button class="btn-warning" onclick="restartWebApp()">ğŸ”„ Restart Web App</button>
                <button class="btn-danger" onclick="cleanupDatabase()">ğŸ—‘ï¸ Cleanup Old Data</button>
            </div>
        </div>
    </div>

    <script>
        // Enhanced admin panel JavaScript with automation

        // Token form submission
        document.getElementById('token-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const token = document.getElementById('access-token').value.trim();

            if (!token) {
                alert('Please enter access token');
                return;
            }

            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ACCESS_TOKEN: token})
                });

                const data = await response.json();

                if (data.ok) {
                    alert('âœ… Access token updated successfully!');
                    document.getElementById('access-token').value = '';
                    updateTokenStatus();
                } else {
                    alert('âŒ Failed to update token: ' + data.error);
                }
            } catch (error) {
                alert('âŒ Error updating token: ' + error.message);
            }
        });

        // Future form submission
        document.getElementById('future-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const futureKey = document.getElementById('future-key').value.trim();

            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({NIFTY_FUTURE_key: futureKey})
                });

                const data = await response.json();

                if (data.ok) {
                    alert('âœ… Future key updated successfully!');
                } else {
                    alert('âŒ Failed to update future key: ' + data.error);
                }
            } catch (error) {
                alert('âŒ Error updating future key: ' + error.message);
            }
        });

        // Fetch instruments (NEW AUTOMATION FEATURE)
        document.getElementById('fetch-instruments-btn').addEventListener('click', async () => {
            const btn = document.getElementById('fetch-instruments-btn');
            const status = document.getElementById('fetch-status');

            btn.disabled = true;
            btn.textContent = 'â³ Fetching...';

            try {
                const response = await fetch('/api/fetch-instruments', {method: 'POST'});
                const data = await response.json();

                if (data.ok) {
                    status.innerHTML = '<span class="success">âœ… Instruments fetched successfully</span>';
                    await loadExpiries();
                    document.getElementById('extract-options-btn').disabled = false;
                    updateNSEStatus();
                } else {
                    status.innerHTML = `<span class="error">âŒ ${data.error}</span>`;
                }
            } catch (error) {
                status.innerHTML = `<span class="error">âŒ ${error.message}</span>`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ”„ Fetch Instruments';
            }
        });

        // Load expiries (NEW AUTOMATION FEATURE)
        async function loadExpiries() {
            try {
                const response = await fetch('/api/get-expiries');
                const data = await response.json();

                if (data.ok) {
                    const select = document.getElementById('expiry-select');
                    select.innerHTML = '';

                    data.expiries.forEach(expiry => {
                        const option = document.createElement('option');
                        option.value = expiry;
                        option.textContent = expiry;
                        if (expiry === data.latest_expiry) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });

                    document.getElementById('nse-instruments-count').textContent = data.expiries.length + ' expiries available';
                }
            } catch (error) {
                console.error('Error loading expiries:', error);
            }
        }

        // Extract options (NEW AUTOMATION FEATURE)
        document.getElementById('extract-options-btn').addEventListener('click', async () => {
            const btn = document.getElementById('extract-options-btn');
            const status = document.getElementById('extract-status');
            const expiry = document.getElementById('expiry-select').value;

            if (!expiry) {
                alert('Please select an expiry date');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'â³ Extracting...';

            try {
                const response = await fetch('/api/extract-options', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({expiry_date: expiry})
                });

                const data = await response.json();

                if (data.ok) {
                    status.innerHTML = '<span class="success">âœ… Options extracted successfully</span>';
                    updateOptionsInfo();
                } else {
                    status.innerHTML = `<span class="error">âŒ ${data.error}</span>`;
                }
            } catch (error) {
                status.innerHTML = `<span class="error">âŒ ${error.message}</span>`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ“Š Extract 60 Options';
            }
        });

        // Manual CSV upload (existing feature)
        document.getElementById('csv-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fileInput = document.getElementById('csv-file');
            const file = fileInput.files[0];

            if (!file) {
                alert('Please select a CSV file');
                return;
            }

            const formData = new FormData();
            formData.append('csv_file', file);

            try {
                const response = await fetch('/api/upload-csv', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.ok) {
                    alert('âœ… CSV uploaded successfully!');
                    fileInput.value = '';
                    updateOptionsInfo();
                } else {
                    alert('âŒ Failed to upload CSV: ' + data.error);
                }
            } catch (error) {
                alert('âŒ Error uploading CSV: ' + error.message);
            }
        });

        // Update token status (NEW FEATURE)
        async function updateTokenStatus() {
            try {
                const response = await fetch('/api/config');
                const data = await response.json();

                if (data.ok) {
                    const config = data.config;
                    const tokenDate = config.TOKEN_UPDATE_DATE;
                    const today = new Date().toISOString().split('T')[0];

                    document.getElementById('token-last-updated').textContent =
                        tokenDate ? new Date(tokenDate).toLocaleDateString() : 'Never';

                    const statusElement = document.getElementById('token-validation-status');
                    if (tokenDate === today) {
                        statusElement.innerHTML = 'âœ… Updated Today';
                        statusElement.className = 'success';
                    } else {
                        statusElement.innerHTML = 'âŒ Not Updated Today';
                        statusElement.className = 'error';
                    }
                }
            } catch (error) {
                console.error('Error updating token status:', error);
            }
        }

        // Update NSE status (NEW FEATURE)
        async function updateNSEStatus() {
            try {
                // Check if NSE.csv exists
                const response = await fetch('/api/get-expiries');
                const data = await response.json();

                if (data.ok && data.expiries.length > 0) {
                    document.getElementById('nse-csv-status').textContent = 'Generated';
                    document.getElementById('nse-instruments-count').textContent = data.expiries.length + ' expiries available';
                } else {
                    document.getElementById('nse-csv-status').textContent = 'Not generated';
                    document.getElementById('nse-instruments-count').textContent = '0';
                }
            } catch (error) {
                document.getElementById('nse-csv-status').textContent = 'Error checking';
            }
        }

        // Update options info (NEW FEATURE)
        async function updateOptionsInfo() {
            try {
                const response = await fetch('/api/csv-info');
                const data = await response.json();

                if (data.ok) {
                    document.getElementById('current-options-count').textContent = data.total_options;
                    document.getElementById('current-ce-count').textContent = data.ce_count;
                    document.getElementById('current-pe-count').textContent = data.pe_count;
                    document.getElementById('options-last-updated').textContent =
                        data.last_updated ? new Date(data.last_updated).toLocaleString() : 'Never';
                }
            } catch (error) {
                console.error('Error updating options info:', error);
            }
        }

        // Load system status (existing)
        async function loadSystemStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();

                if (data.ok) {
                    // Update pipeline status
                    const pipelineStatus = document.getElementById('pipeline-status');
                    const pipelineDot = pipelineStatus.querySelector('.status-dot');
                    const pipelineText = pipelineStatus.querySelector('.status-text');

                    if (data.pipeline_running) {
                        pipelineDot.style.background = '#4caf50';
                        pipelineText.textContent = 'RUNNING';
                    } else {
                        pipelineDot.style.background = '#f44336';
                        pipelineText.textContent = 'STOPPED';
                    }

                    // Update market status
                    const marketStatus = document.getElementById('market-status');
                    const marketDot = marketStatus.querySelector('.status-dot');
                    const marketText = marketStatus.querySelector('.status-text');

                    if (data.market_hours) {
                        marketDot.style.background = '#4caf50';
                        marketText.textContent = 'OPEN';
                    } else {
                        marketDot.style.background = '#ff9800';
                        marketText.textContent = 'CLOSED';
                    }

                    // Update memory info
                    const memoryUsed = document.getElementById('memory-used');
                    const memoryText = document.getElementById('memory-text');

                    const memoryPercent = data.memory.percentage;
                    memoryUsed.style.width = memoryPercent + '%';
                    memoryText.textContent = `${data.memory.used}GB / ${data.memory.total}GB (${memoryPercent.toFixed(1)}%)`;

                    if (memoryPercent > 80) {
                        memoryUsed.style.background = '#f44336';
                    } else if (memoryPercent > 60) {
                        memoryUsed.style.background = '#ff9800';
                    } else {
                        memoryUsed.style.background = '#4caf50';
                    }
                }
            } catch (error) {
                console.error('Error loading system status:', error);
            }
        }

        // Service control functions (existing)
        async function restartPipeline() {
            if (confirm('Restart trading pipeline? This will briefly interrupt data collection.')) {
                try {
                    const response = await fetch('/api/restart-pipeline', {method: 'POST'});
                    const data = await response.json();
                    if (data.ok) {
                        alert('âœ… Pipeline restart initiated');
                    } else {
                        alert('âŒ Failed to restart pipeline: ' + data.error);
                    }
                } catch (error) {
                    alert('âŒ Error: ' + error.message);
                }
            }
        }

        async function restartWebApp() {
            if (confirm('Restart web application? You will be logged out.')) {
                try {
                    const response = await fetch('/api/restart-webapp', {method: 'POST'});
                    const data = await response.json();
                    if (data.ok) {
                        alert('âœ… Web app restart initiated');
                        window.location.href = '/login';
                    } else {
                        alert('âŒ Failed to restart web app: ' + data.error);
                    }
                } catch (error) {
                    alert('âŒ Error: ' + error.message);
                }
            }
        }

        async function cleanupDatabase() {
            if (confirm('Clean up old database records? This will remove data older than 30 days.')) {
                try {
                    const response = await fetch('/admin/cleanup', {method: 'POST'});
                    const data = await response.json();
                    if (data.ok) {
                        alert('âœ… Database cleanup completed');
                    } else {
                        alert('âŒ Failed to cleanup database: ' + data.error);
                    }
                } catch (error) {
                    alert('âŒ Error: ' + error.message);
                }
            }
        }

        // Initialize page (NEW ENHANCED INITIALIZATION)
        document.addEventListener('DOMContentLoaded', () => {
            updateTokenStatus();
            updateNSEStatus();
            updateOptionsInfo();
            loadSystemStatus();

            // Auto-refresh every 30 seconds
            setInterval(() => {
                updateTokenStatus();
                updateNSEStatus();
                updateOptionsInfo();
                loadSystemStatus();
            }, 30000);
        });
    </script>
</body>
</html>
